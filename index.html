<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Chewing æ…¢é£Ÿä¼´ä¾£</title>
    <style>
        :root {
            --primary: #4ecca3;
            --focus: #3b82f6;
            --rest: #f59e0b;
            --bg: #f8fafc;
            --text: #1e293b;
            --card: #ffffff;
        }

        body {
            margin: 0;
            padding: 0;
            background-color: var(--bg);
            color: var(--text);
            font-family: -apple-system, BlinkMacSystemFont, "SF Pro Display", "PingFang SC", "Hiragino Sans GB", "Microsoft YaHei UI", "Microsoft YaHei", "Source Han Sans CN", "Noto Sans SC", sans-serif;
            display: flex;
            flex-direction: column;
            height: 100dvh; 
            overflow: hidden;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        header {
            padding: 15px 20px;
            padding-top: max(15px, env(safe-area-inset-top)); 
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: var(--card);
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            z-index: 100;
            flex-shrink: 0;
        }
        h1 { margin: 0; font-size: 1.2rem; font-weight: 600; color: #333; letter-spacing: 0.5px; }
        
        .header-right { display: flex; gap: 15px; }
        .icon-btn { background: none; border: none; font-size: 1.4rem; cursor: pointer; padding: 5px; opacity: 0.7; transition: opacity 0.2s; }

        main {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            position: relative;
            width: 100%;
        }

        .stats-pill {
            position: absolute;
            top: 20px;
            background: rgba(0,0,0,0.05);
            padding: 8px 16px;
            border-radius: 30px;
            font-size: 0.9rem;
            font-weight: 500;
            color: #666;
            letter-spacing: 0.3px;
        }

        .circle-container {
            width: min(260px, 70vw);
            height: min(260px, 70vw);
            position: relative;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .circle-bg {
            width: 100%; height: 100%; border-radius: 50%; background: #fff;
            box-shadow: 0 20px 40px rgba(0,0,0,0.08);
            position: absolute;
            transition: transform 0.6s cubic-bezier(0.25, 0.8, 0.25, 1);
        }

        .circle-inner {
            width: 90%; height: 90%; border-radius: 50%;
            display: flex; flex-direction: column;
            justify-content: center; align-items: center;
            z-index: 2; transition: background-color 0.5s ease;
        }

        .instruction-main {
            font-size: 1.8rem;
            font-weight: 600; 
            color: white;
            text-align: center;
            line-height: 1.2;
            text-shadow: 0 2px 4px rgba(0,0,0,0.1);
            letter-spacing: 1px;
        }
        .instruction-sub { font-size: 1rem; color: rgba(255,255,255,0.9); margin-top: 8px; letter-spacing: 0.5px; font-weight: 400; }

        .state-bite .circle-bg { transform: scale(1); }
        .state-bite .circle-inner { background-color: var(--primary); }
        .state-chew .circle-inner { background-color: var(--focus); }
        .state-chew .circle-bg { background-color: rgba(59, 130, 246, 0.2); animation: pulseJaw 0.5s infinite alternate; }
        .state-rest .circle-bg { transform: scale(0.85); }
        .state-rest .circle-inner { background-color: var(--rest); }
        @keyframes pulseJaw { from { transform: scale(1); } to { transform: scale(1.15); } }

        .control-bar {
            background: var(--card); display: flex; justify-content: center; gap: 20px;
            border-radius: 30px 30px 0 0; box-shadow: 0 -5px 20px rgba(0,0,0,0.05); flex-shrink: 0;
            padding: 30px; padding-bottom: max(30px, env(safe-area-inset-bottom) + 20px);
        }

        .btn {
            padding: 15px 30px; border-radius: 50px; border: none;
            font-size: 1.1rem; font-weight: 600; cursor: pointer;
            transition: transform 0.1s; width: 140px;
            letter-spacing: 1px;
        }
        .btn:active { transform: scale(0.96); }
        .btn-primary { background: #333; color: white; }
        .btn-secondary { background: #e2e8f0; color: #333; }
        .btn-danger { background: #fee2e2; color: #ef4444; }

        /* --- å¼¹çª—æ ·å¼ --- */
        .modal {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.5); display: none;
            justify-content: center; align-items: center; z-index: 200; backdrop-filter: blur(5px);
        }
        .modal.active { display: flex; }
        .modal-content {
            background: white; width: 85%; max-width: 400px; border-radius: 24px; padding: 30px;
            box-shadow: 0 20px 50px rgba(0,0,0,0.15); animation: fadeInScale 0.25s ease-out;
        }
        @keyframes fadeInScale { from { opacity: 0; transform: scale(0.95); } to { opacity: 1; transform: scale(1); } }
        
        h2 { margin-top: 0; font-weight: 600; letter-spacing: 0.5px; }
        
        /* æ°”æ³¡è·Ÿéšæ»‘å—è®¾è®¡ */
        .slider-group { position: relative; margin-top: 40px; margin-bottom: 10px; }
        .slider-wrapper { display: flex; align-items: center; gap: 15px; color: #999; font-size: 0.9rem; position: relative; }
        .range-bubble {
            position: absolute; bottom: 35px; left: 50%; transform: translateX(-50%);
            background-color: var(--primary); color: white; padding: 4px 10px;
            border-radius: 12px; font-size: 0.9rem; font-weight: 600; white-space: nowrap; pointer-events: none;
            box-shadow: 0 4px 10px rgba(78, 204, 163, 0.3);
        }
        .range-bubble::after {
            content: ''; position: absolute; top: 100%; left: 50%; margin-left: -5px;
            border-width: 5px; border-style: solid; border-color: var(--primary) transparent transparent transparent;
        }
        .setting-header { margin-bottom: 5px; }
        input[type=range] { flex: 1; accent-color: var(--primary); cursor: pointer; width: 100%; }
        
        .history-list { max-height: 300px; overflow-y: auto; list-style: none; padding: 0; }
        .history-item { display: flex; justify-content: space-between; padding: 15px 0; border-bottom: 1px solid #eee; font-size: 0.9rem; }
        .close-btn-full { width: 100%; margin-top: 20px; }
        .help-step { display: flex; align-items: flex-start; margin-bottom: 15px; }
        .step-dot { width: 12px; height: 12px; border-radius: 50%; margin-top: 5px; margin-right: 12px; flex-shrink: 0; }
        .dot-green { background: var(--primary); } .dot-blue { background: var(--focus); } .dot-orange { background: var(--rest); }

    </style>
</head>
<body>

    <header>
        <button class="icon-btn" onclick="openHistory()" aria-label="History">ğŸ“Š</button>
        <h1>Chewing</h1>
        <div class="header-right">
            <button class="icon-btn" onclick="openHelp()" aria-label="Help">â”</button>
            <button class="icon-btn" onclick="openSettings()" aria-label="Settings">âš™ï¸</button>
        </div>
    </header>

    <main id="appContainer" class="state-bite">
        <div class="stats-pill">
            å£æ•°: <span id="dispBites">0</span> | æ—¶é•¿: <span id="dispTime">00:00</span>
        </div>

        <div class="circle-container">
            <div class="circle-bg"></div>
            <div class="circle-inner">
                <div class="instruction-main" id="mainText">Chewing</div>
                <div class="instruction-sub" id="subText">æ…¢é£Ÿä¼´ä¾£</div>
            </div>
        </div>
    </main>

    <div class="control-bar">
        <button id="btnMain" class="btn btn-primary" onclick="toggleState()">å¼€å§‹ç”¨é¤</button>
        <button id="btnFinish" class="btn btn-danger" style="display:none;" onclick="finishMeal()">ç»“æŸç”¨é¤</button>
    </div>

    <div id="modalHelp" class="modal" onclick="if(event.target===this) closeHelp()">
        <div class="modal-content">
            <h2>ä½¿ç”¨è¯´æ˜</h2>
            <div class="help-step"><div class="step-dot dot-green"></div><div><strong>1. è¿›é£Ÿ (ç»¿è‰²)</strong><span>æ‹¿èµ·é£Ÿç‰©æ”¾å…¥å£ä¸­ã€‚</span></div></div>
            <div class="help-step"><div class="step-dot dot-blue"></div><div><strong>2. å’€åš¼ (è“è‰²è„‰åŠ¨)</strong><span>è·Ÿéšåœ†åœˆçš„å‘¼å¸èŠ‚å¥å’€åš¼ã€‚</span></div></div>
            <div class="help-step"><div class="step-dot dot-orange"></div><div><strong>3. ä¼‘æ¯ (æ©™è‰²)</strong><span>åå’½é£Ÿç‰©ï¼Œæ”¾ä¸‹é¤å…·æ·±å‘¼å¸ã€‚</span></div></div>
            <button class="btn btn-secondary close-btn-full" onclick="closeHelp()">çŸ¥é“äº†</button>
        </div>
    </div>

    <div id="modalSettings" class="modal" onclick="if(event.target===this) closeSettings()">
        <div class="modal-content">
            <h2>è®¾ç½®</h2>
            
            <div style="margin-bottom: 25px;">
                <div class="setting-header">
                    <label><strong>å’€åš¼æ—¶é—´</strong></label>
                </div>
                
                <div class="slider-group">
                    <div id="rangeBubble" class="range-bubble">30ç§’</div>
                    
                    <div class="slider-wrapper">
                        <span>10s</span>
                        <input type="range" id="chewRange" min="10" max="100" value="30" oninput="updateSettingsUI()">
                        <span>100s</span>
                    </div>
                </div>
                
                <p style="font-size:0.8rem; color:#999; margin-top:20px;">è°ƒæ•´æ¯æ¬¡å’€åš¼çš„æ—¶é•¿/æ¬¡æ•°ã€‚</p>
            </div>

            <button class="btn btn-primary close-btn-full" onclick="closeSettings()">ä¿å­˜</button>
        </div>
    </div>

    <div id="modalHistory" class="modal" onclick="if(event.target===this) closeHistory()">
        <div class="modal-content">
            <div style="display:flex; justify-content:space-between; align-items:center;">
                <h2>ç”¨é¤è®°å½•</h2>
                <button onclick="clearHistory()" style="background:none; border:none; color:red; font-size:0.9rem;">æ¸…ç©º</button>
            </div>
            <ul id="historyList" class="history-list"></ul>
            <button class="btn btn-secondary close-btn-full" onclick="closeHistory()">å…³é—­</button>
        </div>
    </div>

    <script>
        let config = { biteTime: 3000, chewTime: 30000, restTime: 5000 };
        let state = { isRunning: false, isPaused: false, bites: 0, totalSeconds: 0, timerInterval: null, phaseTimeout: null };
        
        const els = {
            container: document.getElementById('appContainer'),
            mainText: document.getElementById('mainText'),
            subText: document.getElementById('subText'),
            btnMain: document.getElementById('btnMain'),
            btnFinish: document.getElementById('btnFinish'),
            dispBites: document.getElementById('dispBites'),
            dispTime: document.getElementById('dispTime'),
            chewRange: document.getElementById('chewRange'),
            rangeBubble: document.getElementById('rangeBubble'),
            historyList: document.getElementById('historyList')
        };

        function toggleState() { if (!state.isRunning) startMeal(); else if (state.isPaused) resumeMeal(); else pauseMeal(); }
        
        function startMeal() { 
            state.isRunning = true; state.isPaused = false; state.bites = 0; state.totalSeconds = 0; 
            updateStats(); 
            els.btnMain.innerText = "æš‚åœ"; els.btnMain.className = "btn btn-secondary"; els.btnFinish.style.display = "block"; 
            if(state.timerInterval) clearInterval(state.timerInterval); 
            state.timerInterval = setInterval(() => { state.totalSeconds++; updateStats(); }, 1000); 
            runPhase('bite'); 
        }
        
        function pauseMeal() { state.isPaused = true; clearTimeout(state.phaseTimeout); els.btnMain.innerText = "ç»§ç»­"; els.btnMain.className = "btn btn-primary"; els.mainText.innerText = "å·²æš‚åœ"; els.subText.innerText = "è°ƒæ•´å‘¼å¸"; els.container.className = "state-rest"; }
        function resumeMeal() { state.isPaused = false; els.btnMain.innerText = "æš‚åœ"; els.btnMain.className = "btn btn-secondary"; runPhase('bite'); }
        
        function finishMeal() { 
            saveHistory(); 
            clearInterval(state.timerInterval); clearTimeout(state.phaseTimeout); 
            state.isRunning = false; state.isPaused = false; 
            els.btnMain.innerText = "å¼€å§‹ç”¨é¤"; els.btnMain.className = "btn btn-primary"; els.btnFinish.style.display = "none"; 
            els.container.className = "state-rest"; 
            // Reset to branding on finish
            els.mainText.innerText = "Chewing"; els.subText.innerText = "æ…¢é£Ÿä¼´ä¾£"; 
        }

        function runPhase(phase) {
            if (!state.isRunning || state.isPaused) return;
            let duration = phase === 'bite' ? config.biteTime : phase === 'chew' ? config.chewTime : config.restTime;
            if (phase === 'bite') { els.container.className = "state-bite"; els.mainText.innerText = "åƒä¸€å£"; els.subText.innerText = "æ‹¿èµ·é£Ÿç‰©"; state.phaseTimeout = setTimeout(() => { state.bites++; updateStats(); runPhase('chew'); }, duration); } 
            else if (phase === 'chew') { els.container.className = "state-chew"; els.mainText.innerText = "ç»†åš¼æ…¢å’½"; els.subText.innerText = "è·ŸéšèŠ‚å¥"; state.phaseTimeout = setTimeout(() => { runPhase('rest'); }, duration); } 
            else if (phase === 'rest') { els.container.className = "state-rest"; els.mainText.innerText = "åå’½ & ä¼‘æ¯"; els.subText.innerText = "æ·±å‘¼å¸..."; state.phaseTimeout = setTimeout(() => { runPhase('bite'); }, duration); }
        }
        
        function updateStats() { els.dispBites.innerText = state.bites; const m = Math.floor(state.totalSeconds / 60).toString().padStart(2, '0'); const s = (state.totalSeconds % 60).toString().padStart(2, '0'); els.dispTime.innerText = `${m}:${s}`; }

        function openSettings() { document.getElementById('modalSettings').classList.add('active'); updateSettingsUI(); }
        function closeSettings() { document.getElementById('modalSettings').classList.remove('active'); config.chewTime = parseInt(els.chewRange.value) * 1000; }
        
        function updateSettingsUI() {
            const range = els.chewRange;
            const bubble = els.rangeBubble;
            const val = range.value;
            const min = range.min ? range.min : 0;
            const max = range.max ? range.max : 100;
            bubble.innerText = val + "ç§’";
            const newVal = Number(((val - min) * 100) / (max - min));
            bubble.style.left = `calc(${newVal}% + (${8 - newVal * 0.15}px))`;
        }
        
        function openHistory() { document.getElementById('modalHistory').classList.add('active'); renderHistory(); }
        function closeHistory() { document.getElementById('modalHistory').classList.remove('active'); }
        function openHelp() { document.getElementById('modalHelp').classList.add('active'); }
        function closeHelp() { document.getElementById('modalHelp').classList.remove('active'); }
        function saveHistory() { if(state.bites===0)return; let h=JSON.parse(localStorage.getItem('savorHistory')||'[]'); h.unshift({date:new Date().toLocaleString('zh-CN'), bites:state.bites, duration:state.totalSeconds}); if(h.length>20)h.pop(); localStorage.setItem('savorHistory',JSON.stringify(h)); }
        function renderHistory() { let h=JSON.parse(localStorage.getItem('savorHistory')||'[]'); els.historyList.innerHTML = h.length ? '' : '<li style="text-align:center;color:#999;padding:20px;">æš‚æ— è®°å½•</li>'; h.forEach(i=>{ let d = i.date.split(' ')[0]; let t = i.date.split(' ')[1] || ''; els.historyList.innerHTML+=`<li class="history-item"><span><strong>${d}</strong><br>${t}</span><span>${i.bites} å£</span></li>` }); }
        function clearHistory() { localStorage.removeItem('savorHistory'); renderHistory(); }
    </script>
</body>
</html>